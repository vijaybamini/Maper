<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My College Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <style>
        #map { height: 500px; width: 100%; }
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            margin: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .progress-bar {
            width: 100px;
            height: 15px;
            background-color: #ddd;
            border-radius: 7px;
            overflow: hidden;
            border: 1px solid #bbb;
            position: relative;
        }
        .progress {
    height: 100%;
    width: 0%;
    background-color: #4caf50;
    transition: none;  /* Remove transition */
    text-align: center;
    color: white;
    font-size: 12px;
    font-weight: bold;
    line-height: 15px;
}

    </style>
</head>
<body>
    <div id="map"></div>

    <script>
        var map = L.map('map').setView([17.984196, 79.531958], 17);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

var dustbins = {
    "32": { "coords": [17.984397, 79.529581], "marker": null },
    "35": { "coords": [17.984196, 79.531958], "marker": null }
};

// ✅ Function to create marker with Image + Progress Bar
function createMarkerWithProgress(dustbin_no, coords) {
    let markerHtml = `
        <div style="
            position: relative;
            width: 50px; height: 60px;
            text-align: center;
        ">
            <!-- Dustbin Image -->
            <img src="/static/green_dustbin.png" style="width: 100%; height: 50px; display: block;">
            
            <!-- Progress Bar Overlay -->
            <div style="
                width: 50px; height: 8px;
                background: #ddd;
                border-radius: 5px;
                border: 1px solid #bbb;
                position: absolute;
                bottom: 0;
                left: 50%;
                transform: translateX(-50%);
            ">
                <div id="progress-${dustbin_no}" style="
                    width: 0%; height: 100%;
                    background: #4caf50;
                    text-align: center;
                    font-size: 7px;
                    color: white;
                    line-height: 8px;
                    border-radius: 5px;
                    transition: width 0.3s ease-in-out;
                ">0%</div>
            </div>
        </div>
    `;

    let icon = L.divIcon({
        className: 'custom-marker',
        html: markerHtml,
        iconSize: [50, 60], // Size of the marker
        iconAnchor: [25, 30], // Positioning on map
    });

    return L.marker(coords, { icon }).addTo(map);
}

// ✅ Create markers for all dustbins
for (let bin in dustbins) {
    dustbins[bin].marker = createMarkerWithProgress(bin, dustbins[bin].coords);
}

// ✅ Function to update progress bar
function updateProgressBar(dustbin_no, percentage) {
    let progress = document.getElementById(`progress-${dustbin_no}`);
    if (progress) {
        percentage = Math.max(0, Math.min(100, percentage)); // Keep between 0-100
        progress.style.width = percentage + "%";
        progress.innerText = percentage + "%";
        progress.style.backgroundColor = (percentage >= 90) ? 'red' : '#4caf50';
    }
}

// ✅ Fetch sensor data and update progress bars
function fetchSensorData() {
    fetch("/get-data")
        .then(response => response.json())
        .then(data => {
            for (let dustbin_no in data) {
                let latest_percentage = data[dustbin_no] || 0;
                updateProgressBar(dustbin_no, latest_percentage);
            }
        })
        .catch(error => console.error("Error fetching data:", error));
}

// Fetch and update every 5 seconds
fetchSensorData();
setInterval(fetchSensorData, 5000);

    </script>
    
</body>
</html>
