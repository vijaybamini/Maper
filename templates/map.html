<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My College Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <style>
        #map { height: 500px; width: 100%; }
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            margin: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .progress-bar {
            width: 100px;
            height: 15px;
            background-color: #ddd;
            border-radius: 7px;
            overflow: hidden;
            border: 1px solid #bbb;
            position: relative;
        }
        .progress {
    height: 100%;
    width: 0%;
    background-color: #4caf50;
    transition: none;  /* Remove transition */
    text-align: center;
    color: white;
    font-size: 12px;
    font-weight: bold;
    line-height: 15px;
}
.hello{
    background: #000000;
   
}

    </style>
</head>
<body>
    <div id="map"></div>

    <script>
        var map = L.map('map').setView([17.984196, 79.531958], 17);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

var dustbins = {
    "32": { "coords": [17.984397, 79.529581], "marker": null },
    "35": { "coords": [17.984196, 79.531958], "marker": null }
};

// ✅ Function to create marker with Image + Circular Progress Bar
function createMarkerWithSpeedometer(dustbin_no, coords) {
    let markerHtml = `
        <div style="
            position: relative;
            width: 60px; height: 70px;
            text-align: center;
        ">
            <!-- Circular Progress Bar (Speedometer) -->
           <svg viewBox="0 0 36 36" width="50" height="50" style="
    position: absolute;
    top: -30px;
    left: 50%;
    transform: translateX(-50%);
">
    <!-- Background circle -->
    <circle cx="18" cy="18" r="15" fill="none" stroke="#000000" stroke-width="3"/>
    <!-- Progress circle -->
    <circle id="progress-${dustbin_no}" cx="18" cy="18" r="15" fill="none"
        stroke="#213fff" stroke-width="3" stroke-dasharray="94.2" stroke-dashoffset="94.2"
        transform="rotate(-90 18 18)" />
    <!-- ✅ Text displaying percentage -->
    <text id="progress-text-${dustbin_no}" x="50%" y="50%" dominant-baseline="middle" text-anchor="middle"
        font-size="8px" fill="#000">
        0%
    </text>
</svg>

            <!-- Dustbin Image -->
            <img src="/static/green_dustbin.png" style="width: 100%; height:70px; display: block;">
        </div>
    `;

    let icon = L.divIcon({
        className: 'custom-marker',
        html: markerHtml,
        iconSize: [32, 80], // Size of the marker
        iconAnchor: [30, 35], // Positioning on map
    });

    return L.marker(coords, { icon }).addTo(map);
}

// ✅ Create markers for all dustbins
for (let bin in dustbins) {
    dustbins[bin].marker = createMarkerWithSpeedometer(bin, dustbins[bin].coords);
}

// ✅ Function to update speedometer progress
function updateSpeedometer(dustbin_no, percentage) {
    let circle = document.getElementById(`progress-${dustbin_no}`);
    let text = document.getElementById(`text-${dustbin_no}`);

    if (circle && text) {
        percentage = Math.max(0, Math.min(100, percentage)); // Ensure between 0-100

        // Convert percentage to circular progress value
        let progress = 94.2 - (percentage / 100) * 94.2; // 94.2 is full stroke

        circle.style.strokeDashoffset = progress; // Update stroke
        circle.style.stroke = (percentage >= 90) ? 'red' : '#4caf50'; // Change color
        text.innerText = `${percentage}%`; // Update text
    }
}

// ✅ Fetch sensor data and update speedometers
function fetchSensorData() {
    fetch("/get-data")
        .then(response => response.json())
        .then(data => {
            for (let dustbin_no in data) {
                let latest_percentage = data[dustbin_no] || 0;
                updateSpeedometer(dustbin_no, latest_percentage);
            }
        })
        .catch(error => console.error("Error fetching data:", error));
}

// Fetch and update every 5 seconds
fetchSensorData();
setInterval(fetchSensorData, 5000);


    </script>
    
</body>
</html>
